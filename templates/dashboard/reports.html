{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1">Reports</h2>
      <p class="text-muted mb-0">Create and review downloadable reports.</p>
    </div>
    <button id="btn-create-report" class="btn btn-primary">Create Report</button>
  </div>

  <!-- CSRF token for fetch POSTs -->
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}" />

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Created</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if reports and reports|length %}
              {% for r in reports %}
                <tr>
                  <td><code>{{ r.report_id }}</code></td>
                  <td>{{ r.status }}</td>
                  <td>{{ r.created_at }}</td>
                  <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="/reports/{{ r.report_id }}">Open</a></td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="text-muted">No reports yet. Click "Create Report" to generate one.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    function getCookie(name){
      const m = document.cookie.match('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)');
      return m ? decodeURIComponent(m[1]) : '';
    }
    const btn = document.getElementById('btn-create-report');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      btn.disabled = true;
      try {
        const payload = { filters: {} };
        const tokenFromField = (document.getElementById('csrf-token')||{}).value || '';
        const csrftoken = tokenFromField || getCookie('csrftoken');
        const res = await fetch('/api/v1/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (data && data.reportId){
          window.location.href = '/reports/' + data.reportId;
        } else {
          alert('Failed to create report');
        }
      } catch(e){
        console.error(e);
        alert('Failed to create report');
      } finally {
        btn.disabled = false;
      }
    });
  });
</script>
{% endblock %}
